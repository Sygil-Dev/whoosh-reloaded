<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tips for speeding up batch indexing &mdash; Whoosh-Reloaded 2.7.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Concurrency, locking, and versioning" href="threads.html" />
    <link rel="prev" title="Field caches" href="fieldcaches.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Whoosh-Reloaded
          </a>
              <div class="version">
                2.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="releases/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction to Whoosh</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema.html">Designing a schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="indexing.html">How to index documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="searching.html">How to search</a></li>
<li class="toctree-l1"><a class="reference internal" href="parsing.html">Parsing user queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="querylang.html">The default query language</a></li>
<li class="toctree-l1"><a class="reference internal" href="dates.html">Indexing and parsing dates/times</a></li>
<li class="toctree-l1"><a class="reference internal" href="query.html">Query objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="analysis.html">About analyzers</a></li>
<li class="toctree-l1"><a class="reference internal" href="stemming.html">Stemming, variations, and accent folding</a></li>
<li class="toctree-l1"><a class="reference internal" href="ngrams.html">Indexing and searching N-grams</a></li>
<li class="toctree-l1"><a class="reference internal" href="facets.html">Sorting and faceting</a></li>
<li class="toctree-l1"><a class="reference internal" href="highlight.html">How to create highlighted search result excerpts</a></li>
<li class="toctree-l1"><a class="reference internal" href="keywords.html">Query expansion and Key word extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="spelling.html">“Did you mean… ?” Correcting errors in user queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="fieldcaches.html">Field caches</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tips for speeding up batch indexing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stemminganalyzer-cache">StemmingAnalyzer cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-limitmb-parameter">The <code class="docutils literal notranslate"><span class="pre">limitmb</span></code> parameter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-procs-parameter">The <code class="docutils literal notranslate"><span class="pre">procs</span></code> parameter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-multisegment-parameter">The <code class="docutils literal notranslate"><span class="pre">multisegment</span></code> parameter</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="threads.html">Concurrency, locking, and versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="nested.html">Indexing and searching document hierarchies</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Whoosh recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/api.html">Whoosh API</a></li>
<li class="toctree-l1"><a class="reference internal" href="tech/index.html">Technical notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Whoosh-Reloaded</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tips for speeding up batch indexing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/batch.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tips-for-speeding-up-batch-indexing">
<h1>Tips for speeding up batch indexing<a class="headerlink" href="#tips-for-speeding-up-batch-indexing" title="Permalink to this heading">¶</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>Indexing documents tends to fall into two general patterns: adding documents
one at a time as they are created (as in a web application), and adding a bunch
of documents at once (batch indexing).</p>
<p>The following settings and alternate workflows can make batch indexing faster.</p>
</section>
<section id="stemminganalyzer-cache">
<h2>StemmingAnalyzer cache<a class="headerlink" href="#stemminganalyzer-cache" title="Permalink to this heading">¶</a></h2>
<p>The stemming analyzer by default uses a least-recently-used (LRU) cache to limit
the amount of memory it uses, to prevent the cache from growing very large if
the analyzer is reused for a long period of time. However, the LRU cache can
slow down indexing by almost 200% compared to a stemming analyzer with an
“unbounded” cache.</p>
<p>When you’re indexing in large batches with a one-shot instance of the
analyzer, consider using an unbounded cache:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">w</span> <span class="o">=</span> <span class="n">myindex</span><span class="o">.</span><span class="n">writer</span><span class="p">()</span>
<span class="c1"># Get the analyzer object from a text field</span>
<span class="n">stem_ana</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">analyzer</span>
<span class="c1"># Set the cachesize to -1 to indicate unbounded caching</span>
<span class="n">stem_ana</span><span class="o">.</span><span class="n">cachesize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="c1"># Reset the analyzer to pick up the changed attribute</span>
<span class="n">stem_ana</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="c1"># Use the writer to index documents...</span>
</pre></div>
</div>
</section>
<section id="the-limitmb-parameter">
<h2>The <code class="docutils literal notranslate"><span class="pre">limitmb</span></code> parameter<a class="headerlink" href="#the-limitmb-parameter" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">limitmb</span></code> parameter to <a class="reference internal" href="api/index.html#whoosh.index.Index.writer" title="whoosh.index.Index.writer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">whoosh.index.Index.writer()</span></code></a> controls the
<em>maximum</em> memory (in megabytes) the writer will use for the indexing pool. The
higher the number, the faster indexing will be.</p>
<p>The default value of <code class="docutils literal notranslate"><span class="pre">128</span></code> is actually somewhat low, considering many people
have multiple gigabytes of RAM these days. Setting it higher can speed up
indexing considerably:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">whoosh</span> <span class="kn">import</span> <span class="n">index</span>

<span class="n">ix</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">open_dir</span><span class="p">(</span><span class="s2">&quot;indexdir&quot;</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">ix</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">limitmb</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The actual memory used will be higher than this value because of interpreter
overhead (up to twice as much!). It is very useful as a tuning parameter,
but not for trying to exactly control the memory usage of Whoosh.</p>
</div>
</section>
<section id="the-procs-parameter">
<h2>The <code class="docutils literal notranslate"><span class="pre">procs</span></code> parameter<a class="headerlink" href="#the-procs-parameter" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">procs</span></code> parameter to <a class="reference internal" href="api/index.html#whoosh.index.Index.writer" title="whoosh.index.Index.writer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">whoosh.index.Index.writer()</span></code></a> controls the
number of processors the writer will use for indexing (via the
<code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">whoosh</span> <span class="kn">import</span> <span class="n">index</span>

<span class="n">ix</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">open_dir</span><span class="p">(</span><span class="s2">&quot;indexdir&quot;</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">ix</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">procs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that when you use multiprocessing, the <code class="docutils literal notranslate"><span class="pre">limitmb</span></code> parameter controls the
amount of memory used by <em>each process</em>, so the actual memory used will be
<code class="docutils literal notranslate"><span class="pre">limitmb</span> <span class="pre">*</span> <span class="pre">procs</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Each process will use a limit of 128, for a total of 512</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">ix</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">procs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">limitmb</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-multisegment-parameter">
<h2>The <code class="docutils literal notranslate"><span class="pre">multisegment</span></code> parameter<a class="headerlink" href="#the-multisegment-parameter" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">procs</span></code> parameter causes the default writer to use multiple processors to
do much of the indexing, but then still uses a single process to merge the pool
of each sub-writer into a single segment.</p>
<p>You can get much better indexing speed by also using the <code class="docutils literal notranslate"><span class="pre">multisegment=True</span></code>
keyword argument, which instead of merging the results of each sub-writer,
simply has them each just write out a new segment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">whoosh</span> <span class="kn">import</span> <span class="n">index</span>

<span class="n">ix</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">open_dir</span><span class="p">(</span><span class="s2">&quot;indexdir&quot;</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">ix</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">procs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">multisegment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The drawback is that instead
of creating a single new segment, this option creates a number of new segments
<strong>at least</strong> equal to the number of processes you use.</p>
<p>For example, if you use <code class="docutils literal notranslate"><span class="pre">procs=4</span></code>, the writer will create four new segments.
(If you merge old segments or call <code class="docutils literal notranslate"><span class="pre">add_reader</span></code> on the parent writer, the
parent writer will also write a segment, meaning you’ll get five new segments.)</p>
<p>So, while <code class="docutils literal notranslate"><span class="pre">multisegment=True</span></code> is much faster than a normal writer, you should
only use it for large batch indexing jobs (or perhaps only for indexing from
scratch). It should not be the only method you use for indexing, because
otherwise the number of segments will tend to increase forever!</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="fieldcaches.html" class="btn btn-neutral float-left" title="Field caches" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="threads.html" class="btn btn-neutral float-right" title="Concurrency, locking, and versioning" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2007-2012 Matt Chaput.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>