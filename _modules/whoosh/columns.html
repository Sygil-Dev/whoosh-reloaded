<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>whoosh.columns &mdash; Whoosh-Reloaded 2.7.5 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Whoosh-Reloaded
          </a>
              <div class="version">
                2.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction to Whoosh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schema.html">Designing a schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../indexing.html">How to index documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../searching.html">How to search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parsing.html">Parsing user queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../querylang.html">The default query language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dates.html">Indexing and parsing dates/times</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query.html">Query objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analysis.html">About analyzers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stemming.html">Stemming, variations, and accent folding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ngrams.html">Indexing and searching N-grams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../facets.html">Sorting and faceting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../highlight.html">How to create highlighted search result excerpts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../keywords.html">Query expansion and Key word extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spelling.html">“Did you mean… ?” Correcting errors in user queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fieldcaches.html">Field caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batch.html">Tips for speeding up batch indexing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../threads.html">Concurrency, locking, and versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nested.html">Indexing and searching document hierarchies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recipes.html">Whoosh recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">Whoosh API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tech/index.html">Technical notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Whoosh-Reloaded</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">whoosh.columns</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for whoosh.columns</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2012 Matt Chaput. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1">#    1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c1">#       this list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1">#    2. Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#       notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#       documentation and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY MATT CHAPUT ``AS IS&#39;&#39; AND ANY EXPRESS OR</span>
<span class="c1"># IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO</span>
<span class="c1"># EVENT SHALL MATT CHAPUT OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="c1"># INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="c1"># LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,</span>
<span class="c1"># OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="c1"># LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="c1"># NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,</span>
<span class="c1"># EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">#</span>
<span class="c1"># The views and conclusions contained in the software and documentation are</span>
<span class="c1"># those of the authors and should not be interpreted as representing official</span>
<span class="c1"># policies, either expressed or implied, of Matt Chaput.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The API and implementation of columns may change in the next version of Whoosh!</span>

<span class="sd">This module contains &quot;Column&quot; objects which you can use as the argument to a</span>
<span class="sd">Field object&#39;s ``sortable=`` keyword argument. Each field defines a default</span>
<span class="sd">column type for when the user specifies ``sortable=True`` (the object returned</span>
<span class="sd">by the field&#39;s ``default_column()`` method).</span>

<span class="sd">The default column type for most fields is ``VarBytesColumn``,</span>
<span class="sd">although numeric and date fields use ``NumericColumn``. Expert users may use</span>
<span class="sd">other field types that may be faster or more storage efficient based on the</span>
<span class="sd">field contents. For example, if a field always contains one of a limited number</span>
<span class="sd">of possible values, a ``RefBytesColumn`` will save space by only storing the</span>
<span class="sd">values once. If a field&#39;s values are always a fixed length, the</span>
<span class="sd">``FixedBytesColumn`` saves space by not storing the length of each value.</span>

<span class="sd">A ``Column`` object basically exists to store configuration information and</span>
<span class="sd">provides two important methods: ``writer()`` to return a ``ColumnWriter`` object</span>
<span class="sd">and ``reader()`` to return a ``ColumnReader`` object.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">bisect_right</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">zlib</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">zlib</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span> <span class="nn">whoosh.compat</span> <span class="kn">import</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="n">array_tobytes</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">,</span> <span class="n">dumps</span><span class="p">,</span> <span class="n">loads</span><span class="p">,</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">whoosh.filedb.structfile</span> <span class="kn">import</span> <span class="n">StructFile</span>
<span class="kn">from</span> <span class="nn">whoosh.idsets</span> <span class="kn">import</span> <span class="n">BitSet</span><span class="p">,</span> <span class="n">OnDiskBitSet</span>
<span class="kn">from</span> <span class="nn">whoosh.system</span> <span class="kn">import</span> <span class="n">emptybytes</span>
<span class="kn">from</span> <span class="nn">whoosh.util.numeric</span> <span class="kn">import</span> <span class="n">typecode_max</span><span class="p">,</span> <span class="n">typecode_min</span>
<span class="kn">from</span> <span class="nn">whoosh.util.numlists</span> <span class="kn">import</span> <span class="n">GrowableArray</span>
<span class="kn">from</span> <span class="nn">whoosh.util.varints</span> <span class="kn">import</span> <span class="n">read_varint</span><span class="p">,</span> <span class="n">varint</span>

<span class="c1"># Base classes</span>


<div class="viewcode-block" id="Column"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.Column">[docs]</a><span class="k">class</span> <span class="nc">Column</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a &quot;column&quot; of rows mapping docnums to document values.</span>

<span class="sd">    The interface requires that you store the start offset of the column, the</span>
<span class="sd">    length of the column data, and the number of documents (rows) separately,</span>
<span class="sd">    and pass them to the reader object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">reversible</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Column.writer"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.Column.writer">[docs]</a>    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a :class:`ColumnWriter` object you can use to use to create</span>
<span class="sd">        a column of this type on disk.</span>

<span class="sd">        :param dbfile: the :class:`~ whoosh.filedb.structfile.StructFile` to</span>
<span class="sd">            write to.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="Column.reader"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.Column.reader">[docs]</a>    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a :class:`ColumnReader` object you can use to read a column</span>
<span class="sd">        of this type from disk.</span>

<span class="sd">        :param dbfile: the :class:`~ whoosh.filedb.structfile.StructFile` to</span>
<span class="sd">            read from.</span>
<span class="sd">        :param basepos: the offset within the file at which the column starts.</span>
<span class="sd">        :param length: the length in bytes of the column occupies in the file.</span>
<span class="sd">        :param doccount: the number of rows (documents) in the column.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">)</span></div>

<div class="viewcode-block" id="Column.default_value"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.Column.default_value">[docs]</a>    <span class="k">def</span> <span class="nf">default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the default value for this column type.&quot;&quot;&quot;</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">reverse</span>  <span class="c1"># unused variable</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span></div>

<div class="viewcode-block" id="Column.stores_lists"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.Column.stores_lists">[docs]</a>    <span class="k">def</span> <span class="nf">stores_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if the column stores a list of values for each document</span>
<span class="sd">        instead of a single value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="ColumnWriter"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.ColumnWriter">[docs]</a><span class="k">class</span> <span class="nc">ColumnWriter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">write</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaultbytes</span>
        <span class="k">if</span> <span class="n">docnum</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">docnum</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">):</span>
                <span class="n">write</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="c1"># This method is intentionally left empty.</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ColumnReader"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.ColumnReader">[docs]</a><span class="k">class</span> <span class="nc">ColumnReader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">=</span> <span class="n">basepos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">=</span> <span class="n">doccount</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<span class="c1"># Arbitrary bytes column</span>


<div class="viewcode-block" id="VarBytesColumn"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.VarBytesColumn">[docs]</a><span class="k">class</span> <span class="nc">VarBytesColumn</span><span class="p">(</span><span class="n">Column</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores variable length byte strings. See also :class:`RefBytesColumn`.</span>

<span class="sd">    The current implementation limits the total length of all document values</span>
<span class="sd">    a segment to 2 GB.</span>

<span class="sd">    The default value (the value returned for a document that didn&#39;t have a</span>
<span class="sd">    value assigned to it at indexing time) is an empty bytestring (``b&#39;&#39;``).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_default</span> <span class="o">=</span> <span class="n">emptybytes</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow_offsets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">write_offsets_cutoff</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">15</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param allow_offsets: Whether the column should write offsets when there</span>
<span class="sd">            are many rows in the column (this makes opening the column much</span>
<span class="sd">            faster). This argument is mostly for testing.</span>
<span class="sd">        :param write_offsets_cutoff: Write offsets (for speed) when there are</span>
<span class="sd">            more than this many rows in the column. This argument is mostly</span>
<span class="sd">            for testing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allow_offsets</span> <span class="o">=</span> <span class="n">allow_offsets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_offsets_cutoff</span> <span class="o">=</span> <span class="n">write_offsets_cutoff</span>

    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_offsets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_offsets_cutoff</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">ColumnWriter</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">allow_offsets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">15</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">StructFile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span> <span class="o">=</span> <span class="n">GrowableArray</span><span class="p">(</span><span class="n">allow_longs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span> <span class="o">=</span> <span class="n">GrowableArray</span><span class="p">(</span><span class="n">allow_longs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offset_base</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allow_offsets</span> <span class="o">=</span> <span class="n">allow_offsets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;VarBytes.Writer&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_base</span>
            <span class="k">if</span> <span class="n">docnum</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">docnum</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">base</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">docnum</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset_base</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offset_base</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">docnum</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span><span class="o">.</span><span class="n">array</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="o">.</span><span class="n">array</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">doccount</span><span class="p">)</span>

            <span class="n">dbfile</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>

            <span class="c1"># Only write the offsets if there is a large number of items in the</span>
            <span class="c1"># column, otherwise it&#39;s fast enough to derive them from the lens</span>
            <span class="n">write_offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_offsets</span> <span class="ow">and</span> <span class="n">doccount</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
            <span class="k">if</span> <span class="n">write_offsets</span><span class="p">:</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span>

            <span class="c1"># Backwards compatibility: previous versions only wrote the lengths,</span>
            <span class="c1"># and the last byte of the column was the lengths type code...</span>
            <span class="n">dbfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lengths</span><span class="o">.</span><span class="n">typecode</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
            <span class="c1"># ...but if we wrote offsets, make the last byte &quot;X&quot; so we know</span>
            <span class="k">if</span> <span class="n">write_offsets</span><span class="p">:</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">offsets</span><span class="o">.</span><span class="n">typecode</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">ColumnReader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">=</span> <span class="n">basepos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="n">length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">=</span> <span class="n">doccount</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">had_stored_offsets</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># for testing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_offsets_and_lengths</span><span class="p">()</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;VarBytes.Reader&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">_read_offsets_and_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span>
            <span class="n">basepos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span>
            <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span>
            <span class="n">doccount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span>

            <span class="c1"># The end of the lengths array is the end of the data minus the</span>
            <span class="c1"># typecode byte</span>
            <span class="n">lastbyte</span> <span class="o">=</span> <span class="n">basepos</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="c1"># Load the length typecode from the end</span>
            <span class="n">lens_code</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">dbfile</span><span class="o">.</span><span class="n">get_byte</span><span class="p">(</span><span class="n">lastbyte</span><span class="p">))</span>

            <span class="n">offsets</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">lens_code</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">had_stored_offsets</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># This indicates we wrote the offsets, so get the real lengths</span>
                <span class="c1"># type code</span>
                <span class="n">lens_code</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">dbfile</span><span class="o">.</span><span class="n">get_byte</span><span class="p">(</span><span class="n">lastbyte</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">offsets_code</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">dbfile</span><span class="o">.</span><span class="n">get_byte</span><span class="p">(</span><span class="n">lastbyte</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

                <span class="c1"># Read the offsets from before the last byte</span>
                <span class="n">itemsize</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">offsets_code</span><span class="p">)</span>
                <span class="n">offsetstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">lastbyte</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">doccount</span> <span class="o">*</span> <span class="n">itemsize</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="n">dbfile</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">offsetstart</span><span class="p">,</span> <span class="n">offsets_code</span><span class="p">,</span> <span class="n">doccount</span><span class="p">)</span>
                <span class="n">lastbyte</span> <span class="o">=</span> <span class="n">offsetstart</span>

            <span class="c1"># Load the length array</span>
            <span class="n">itemsize</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">lens_code</span><span class="p">)</span>
            <span class="n">lenstart</span> <span class="o">=</span> <span class="n">lastbyte</span> <span class="o">-</span> <span class="p">(</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">doccount</span><span class="p">)</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="n">dbfile</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">lenstart</span><span class="p">,</span> <span class="n">lens_code</span><span class="p">,</span> <span class="n">doccount</span><span class="p">)</span>

            <span class="c1"># If we didn&#39;t write the offsets, derive them from the lengths</span>
            <span class="k">if</span> <span class="n">offsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span>
                <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">lengths</span><span class="p">:</span>
                    <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                    <span class="n">base</span> <span class="o">+=</span> <span class="n">length</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span> <span class="o">=</span> <span class="n">offsets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span> <span class="o">=</span> <span class="n">lengths</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">emptybytes</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">get</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span>
            <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="n">length</span></div>


<div class="viewcode-block" id="FixedBytesColumn"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.FixedBytesColumn">[docs]</a><span class="k">class</span> <span class="nc">FixedBytesColumn</span><span class="p">(</span><span class="n">Column</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores fixed-length byte strings.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixedlen</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param fixedlen: the fixed length of byte strings in this column.</span>
<span class="sd">        :param default: the default value to use for documents that don&#39;t</span>
<span class="sd">            specify a value. If you don&#39;t specify a default, the column will</span>
<span class="sd">            use ``b&#39;\\x00&#39; * fixedlen``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">fixedlen</span>

        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">fixedlen</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">default</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fixedlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span>
            <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span>
        <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">ColumnWriter</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">fixedlen</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">fixedlen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaultbytes</span> <span class="o">=</span> <span class="n">default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;FixedBytes.Writer&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">docnum</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">docnum</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">ColumnReader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="n">fixedlen</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">=</span> <span class="n">basepos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">=</span> <span class="n">doccount</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">fixedlen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaultbytes</span> <span class="o">=</span> <span class="n">default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">length</span> <span class="o">//</span> <span class="n">fixedlen</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;FixedBytes.Reader&gt;&quot;</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">docnum</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaultbytes</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">*</span> <span class="n">docnum</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span>
            <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">default</span></div>


<span class="c1"># Variable/fixed length reference (enum) column</span>


<div class="viewcode-block" id="RefBytesColumn"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.RefBytesColumn">[docs]</a><span class="k">class</span> <span class="nc">RefBytesColumn</span><span class="p">(</span><span class="n">Column</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores variable-length or fixed-length byte strings, similar to</span>
<span class="sd">    :class:`VarBytesColumn` and :class:`FixedBytesColumn`. However, where those</span>
<span class="sd">    columns stores a value for each document, this column keeps a list of all</span>
<span class="sd">    the unique values in the field, and for each document stores a short</span>
<span class="sd">    pointer into the unique list. For fields where the number of possible</span>
<span class="sd">    values is smaller than the number of documents (for example,</span>
<span class="sd">    &quot;category&quot; or &quot;chapter&quot;), this saves significant space.</span>

<span class="sd">    This column type supports a maximum of 65535 unique values across all</span>
<span class="sd">    documents in a segment. You should generally use this column type where the</span>
<span class="sd">    number of unique values is in no danger of approaching that number (for</span>
<span class="sd">    example, a &quot;tags&quot; field). If you try to index too many unique values, the</span>
<span class="sd">    column will convert additional unique values to the default value and issue</span>
<span class="sd">    a warning using the ``warnings`` module (this will usually be preferable to</span>
<span class="sd">    crashing the indexer and potentially losing indexed documents).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># NOTE that RefBytes is reversible within a single column (we could just</span>
    <span class="c1"># negate the reference number), but it&#39;s NOT reversible ACROSS SEGMENTS</span>
    <span class="c1"># (since different segments can have different uniques values in their</span>
    <span class="c1"># columns), so we have to say that the column type is not reversible</span>
    <span class="n">reversible</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixedlen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param fixedlen: an optional fixed length for the values. If you</span>
<span class="sd">            specify a number other than 0, the column will require all values</span>
<span class="sd">            to be the specified length.</span>
<span class="sd">        :param default: a default value to use for documents that don&#39;t specify</span>
<span class="sd">            one. If you don&#39;t specify a default, the column will use an empty</span>
<span class="sd">            bytestring (``b&#39;&#39;``), or if you specify a fixed length,</span>
<span class="sd">            ``b&#39;\\x00&#39; * fixedlen``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">fixedlen</span>

        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">fixedlen</span> <span class="k">if</span> <span class="n">fixedlen</span> <span class="k">else</span> <span class="n">emptybytes</span>
        <span class="k">elif</span> <span class="n">fixedlen</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">default</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fixedlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">ColumnWriter</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">fixedlen</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">fixedlen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>

            <span class="c1"># At first we&#39;ll buffer refs in a byte array. If the number of</span>
            <span class="c1"># uniques stays below 256, we can just write the byte array. As</span>
            <span class="c1"># soon as the ref count goes above 255, we know we&#39;re going to have</span>
            <span class="c1"># to write shorts, so we&#39;ll switch to writing directly.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refs</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uniques</span> <span class="o">=</span> <span class="p">{</span><span class="n">default</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;RefBytes.Writer&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">docnum</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_refs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">docnum</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">docnum</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">):</span>
                        <span class="n">dbfile</span><span class="o">.</span><span class="n">write_ushort</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>

            <span class="n">uniques</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uniques</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">uniques</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">uniques</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniques</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">refs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ref</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">:</span>
                    <span class="c1"># We won&#39;t be able to use bytes, we have to switch to</span>
                    <span class="c1"># writing unbuffered ushorts</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">:</span>
                        <span class="n">dbfile</span><span class="o">.</span><span class="n">write_ushort</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refs</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">refs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;RefBytesColumn dropped unique value </span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span>
                    <span class="p">)</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">write_ushort</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">docnum</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">_write_uniques</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typecode</span><span class="p">):</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span>
            <span class="n">fixedlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span>
            <span class="n">uniques</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uniques</span>

            <span class="n">dbfile</span><span class="o">.</span><span class="n">write_varint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uniques</span><span class="p">))</span>
            <span class="c1"># Sort unique values by position</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">uniques</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="n">uniques</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fixedlen</span><span class="p">:</span>
                    <span class="n">dbfile</span><span class="o">.</span><span class="n">write_varint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">doccount</span><span class="p">)</span>

            <span class="n">typecode</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span>
            <span class="k">if</span> <span class="n">refs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">refs</span><span class="p">)</span>
                <span class="n">typecode</span> <span class="o">=</span> <span class="n">refs</span><span class="o">.</span><span class="n">typecode</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_write_uniques</span><span class="p">(</span><span class="n">typecode</span><span class="p">)</span>
            <span class="n">dbfile</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">typecode</span><span class="p">))</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">ColumnReader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="n">fixedlen</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">=</span> <span class="n">basepos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">=</span> <span class="n">doccount</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">fixedlen</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_typecode</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">dbfile</span><span class="o">.</span><span class="n">get_byte</span><span class="p">(</span><span class="n">basepos</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">st</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typecode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unpack</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">unpack</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_itemsize</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">size</span>

            <span class="n">dbfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">basepos</span> <span class="o">+</span> <span class="n">doccount</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_itemsize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uniques</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_uniques</span><span class="p">()</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;RefBytes.Reader&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">_read_uniques</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span>
            <span class="n">fixedlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span>

            <span class="n">ucount</span> <span class="o">=</span> <span class="n">dbfile</span><span class="o">.</span><span class="n">read_varint</span><span class="p">()</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">fixedlen</span>
            <span class="n">uniques</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ucount</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fixedlen</span><span class="p">:</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="n">dbfile</span><span class="o">.</span><span class="n">read_varint</span><span class="p">()</span>
                <span class="n">uniques</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dbfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">uniques</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">+</span> <span class="n">docnum</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_itemsize</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_itemsize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uniques</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">get</span>
            <span class="n">basepos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span>
            <span class="n">uniques</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uniques</span>
            <span class="n">unpack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack</span>
            <span class="n">itemsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_itemsize</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">basepos</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">itemsize</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">itemsize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">uniques</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span></div>


<span class="c1"># Numeric column</span>


<div class="viewcode-block" id="NumericColumn"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.NumericColumn">[docs]</a><span class="k">class</span> <span class="nc">NumericColumn</span><span class="p">(</span><span class="n">FixedBytesColumn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores numbers (integers and floats) as compact binary.&quot;&quot;&quot;</span>

    <span class="n">reversible</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param typecode: a typecode character (as used by the ``struct``</span>
<span class="sd">            module) specifying the number type. For example, ``&quot;i&quot;`` for</span>
<span class="sd">            signed integers.</span>
<span class="sd">        :param default: the default value to use for documents that don&#39;t</span>
<span class="sd">            specify one.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_typecode</span> <span class="o">=</span> <span class="n">typecode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typecode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span>
            <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typecode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">FixedBytesColumn</span><span class="o">.</span><span class="n">Writer</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">typecode</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defaultbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pack</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">typecode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;Numeric.Writer&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">docnum</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pack</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">docnum</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">FixedBytesColumn</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">=</span> <span class="n">basepos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">=</span> <span class="n">doccount</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_typecode</span> <span class="o">=</span> <span class="n">typecode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">typecode</span><span class="p">)</span><span class="o">.</span><span class="n">unpack</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defaultbytes</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">typecode</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">typecode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">length</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;Numeric.Reader&gt;&quot;</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">FixedBytesColumn</span><span class="o">.</span><span class="n">Reader</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack</span><span class="p">(</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">key</span>
            <span class="k">return</span> <span class="n">key</span>

        <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typecode</span> <span class="ow">in</span> <span class="s2">&quot;qQ&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_typecode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">set_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1"># Column of boolean values</span>


<div class="viewcode-block" id="BitColumn"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.BitColumn">[docs]</a><span class="k">class</span> <span class="nc">BitColumn</span><span class="p">(</span><span class="n">Column</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores a column of True/False values compactly.&quot;&quot;&quot;</span>

    <span class="n">reversible</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_default</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compress_at</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param compress_at: columns with this number of values or fewer will</span>
<span class="sd">            be saved compressed on disk, and loaded into RAM for reading. Set</span>
<span class="sd">            this to 0 to disable compression.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_compressat</span> <span class="o">=</span> <span class="n">compress_at</span>

    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">^</span> <span class="n">reverse</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">ColumnWriter</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">compressat</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compressat</span> <span class="o">=</span> <span class="n">compressat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bitset</span> <span class="o">=</span> <span class="n">BitSet</span><span class="p">()</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;Bit.Writer&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bitset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span>
            <span class="n">bits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bitset</span><span class="o">.</span><span class="n">bits</span>

            <span class="k">if</span> <span class="n">zlib</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressat</span><span class="p">:</span>
                <span class="n">compressed</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">array_tobytes</span><span class="p">(</span><span class="n">bits</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">ColumnReader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">=</span> <span class="n">basepos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="n">length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">=</span> <span class="n">doccount</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">compressed</span> <span class="o">=</span> <span class="n">dbfile</span><span class="o">.</span><span class="n">get_byte</span><span class="p">(</span><span class="n">basepos</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">compressed</span><span class="p">:</span>
                <span class="n">bbytes</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">dbfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">basepos</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">bitset</span> <span class="o">=</span> <span class="n">BitSet</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">bbytes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">basepos</span><span class="p">)</span>
                <span class="n">bitset</span> <span class="o">=</span> <span class="n">OnDiskBitSet</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bitset</span> <span class="o">=</span> <span class="n">bitset</span>

        <span class="k">def</span> <span class="nf">id_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bitset</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;Bit.Reader&gt;&quot;</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bitset</span>

        <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span> <span class="o">^</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bitset</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="n">i</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="kc">False</span>
                <span class="k">yield</span> <span class="kc">True</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">-</span> <span class="n">i</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bitset</span><span class="p">,</span> <span class="n">OnDiskBitSet</span><span class="p">):</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bitset</span> <span class="o">=</span> <span class="n">BitSet</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">set_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reverse</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1"># Compressed variants</span>


<div class="viewcode-block" id="CompressedBytesColumn"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.CompressedBytesColumn">[docs]</a><span class="k">class</span> <span class="nc">CompressedBytesColumn</span><span class="p">(</span><span class="n">Column</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores variable-length byte strings compressed using deflate (by</span>
<span class="sd">    default).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;zlib&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param level: the compression level to use.</span>
<span class="sd">        :param module: a string containing the name of the compression module</span>
<span class="sd">            to use. The default is &quot;zlib&quot;. The module should export &quot;compress&quot;</span>
<span class="sd">            and &quot;decompress&quot; functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">module</span>

    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">VarBytesColumn</span><span class="o">.</span><span class="n">Writer</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
            <span class="n">VarBytesColumn</span><span class="o">.</span><span class="n">Writer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="n">level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="n">compress</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;CompressedBytes.Writer&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_level</span><span class="p">)</span>
            <span class="n">VarBytesColumn</span><span class="o">.</span><span class="n">Writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">VarBytesColumn</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
            <span class="n">VarBytesColumn</span><span class="o">.</span><span class="n">Reader</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decompress</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="n">decompress</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;CompressedBytes.Reader&gt;&quot;</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">VarBytesColumn</span><span class="o">.</span><span class="n">Reader</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompress</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">VarBytesColumn</span><span class="o">.</span><span class="n">Reader</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompress</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">CompressedBlockColumn</span><span class="p">(</span><span class="n">Column</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An experimental column type that compresses and decompresses blocks of</span>
<span class="sd">    values at a time. This can lead to high compression and decent performance</span>
<span class="sd">    for columns with lots of very short values, but random access times are</span>
<span class="sd">    usually terrible.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;zlib&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param level: the compression level to use.</span>
<span class="sd">        :param blocksize: the size (in KB) of each compressed block.</span>
<span class="sd">        :param module: a string containing the name of the compression module</span>
<span class="sd">            to use. The default is &quot;zlib&quot;. The module should export &quot;compress&quot;</span>
<span class="sd">            and &quot;decompress&quot; functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocksize</span> <span class="o">=</span> <span class="n">blocksize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">module</span>

    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocksize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">ColumnWriter</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_blocksize</span> <span class="o">=</span> <span class="n">blocksize</span> <span class="o">*</span> <span class="mi">1024</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="n">level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="n">compress</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;CompressedBlock.Writer&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_startdoc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_block</span> <span class="o">=</span> <span class="n">emptybytes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span>
            <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_level</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_startdoc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lastdoc</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span><span class="p">))</span>
            <span class="n">dbfile</span><span class="o">.</span><span class="n">write_pickle</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="n">dbfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startdoc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_startdoc</span> <span class="o">=</span> <span class="n">docnum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">docnum</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lastdoc</span> <span class="o">=</span> <span class="n">docnum</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_block</span> <span class="o">+=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocksize</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_emit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
            <span class="c1"># If there&#39;s still a pending block, write it out</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startdoc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_emit</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">ColumnReader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
            <span class="n">ColumnReader</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decompress</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="n">decompress</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dbfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">basepos</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
                <span class="n">startdoc</span><span class="p">,</span> <span class="n">enddoc</span><span class="p">,</span> <span class="n">blocklen</span><span class="p">,</span> <span class="n">lengths</span> <span class="o">=</span> <span class="n">dbfile</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">()</span>
                <span class="n">here</span> <span class="o">=</span> <span class="n">dbfile</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">startdoc</span><span class="p">,</span> <span class="n">enddoc</span><span class="p">,</span> <span class="n">here</span><span class="p">,</span> <span class="n">blocklen</span><span class="p">,</span> <span class="n">lengths</span><span class="p">))</span>
                <span class="n">dbfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">blocklen</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">here</span> <span class="o">+</span> <span class="n">blocklen</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;CompressedBlock.Reader&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">_find_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="c1"># Use binary search instead of linear search</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">right</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">:</span>
                <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">docnum</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">[</span><span class="n">mid</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">docnum</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">[</span><span class="n">mid</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">mid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">_get_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocknum</span><span class="p">):</span>
            <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">[</span><span class="n">blocknum</span><span class="p">]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">blocklen</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">blocklen</span><span class="p">))</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">vlen</span> <span class="ow">in</span> <span class="n">lengths</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">base</span> <span class="p">:</span> <span class="n">base</span> <span class="o">+</span> <span class="n">vlen</span><span class="p">]</span>
                <span class="n">base</span> <span class="o">+=</span> <span class="n">vlen</span>
            <span class="k">return</span> <span class="n">values</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_block</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">emptybytes</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="n">docnum</span><span class="p">]</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">):</span>
                <span class="n">startdoc</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">enddoc</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">startdoc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startdoc</span> <span class="o">-</span> <span class="n">last</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">emptybytes</span>
                <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">docnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startdoc</span><span class="p">,</span> <span class="n">enddoc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">docnum</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">values</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">emptybytes</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">enddoc</span>
            <span class="k">if</span> <span class="n">enddoc</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">-</span> <span class="n">enddoc</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">emptybytes</span>


<div class="viewcode-block" id="StructColumn"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.StructColumn">[docs]</a><span class="k">class</span> <span class="nc">StructColumn</span><span class="p">(</span><span class="n">FixedBytesColumn</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">FixedBytesColumn</span><span class="o">.</span><span class="n">Writer</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_struct</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_struct</span><span class="o">.</span><span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defaultbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="o">*</span><span class="n">default</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;Struct.Writer&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
            <span class="n">FixedBytesColumn</span><span class="o">.</span><span class="n">Writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">FixedBytesColumn</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">basepos</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">doccount</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbfile</span> <span class="o">=</span> <span class="n">dbfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basepos</span> <span class="o">=</span> <span class="n">basepos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">=</span> <span class="n">doccount</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_struct</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_struct</span><span class="o">.</span><span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defaultbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="o">*</span><span class="n">default</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">length</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;Struct.Reader&gt;&quot;</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">FixedBytesColumn</span><span class="o">.</span><span class="n">Reader</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>


<span class="c1"># Utility readers</span>


<span class="k">class</span> <span class="nc">EmptyColumnReader</span><span class="p">(</span><span class="n">ColumnReader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Acts like a reader for a column with no stored values. Always returns</span>
<span class="sd">    the default.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">doccount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param default: the value to return for all &quot;get&quot; requests.</span>
<span class="sd">        :param doccount: the number of documents in the nominal column.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">=</span> <span class="n">doccount</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">MultiColumnReader</span><span class="p">(</span><span class="n">ColumnReader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serializes access to multiple column readers, making them appear to be</span>
<span class="sd">    one large column.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">readers</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param readers: a sequence of column reader objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_readers</span> <span class="o">=</span> <span class="n">readers</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_doc_offsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">offsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">readers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_doc_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_doccount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">readers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_doc_offsets</span> <span class="o">=</span> <span class="n">offsets</span>

    <span class="k">def</span> <span class="nf">_document_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bisect_right</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doc_offsets</span><span class="p">,</span> <span class="n">docnum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reader_and_docnum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="n">rnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_reader</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doc_offsets</span><span class="p">[</span><span class="n">rnum</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rnum</span><span class="p">,</span> <span class="n">docnum</span> <span class="o">-</span> <span class="n">offset</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reader_and_docnum</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readers</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readers</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">r</span>


<span class="k">class</span> <span class="nc">TranslatingColumnReader</span><span class="p">(</span><span class="n">ColumnReader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calls a function to &quot;translate&quot; values from an underlying column reader</span>
<span class="sd">    object before returning them.</span>

<span class="sd">    ``IndexReader`` objects can wrap a column reader with this object to call</span>
<span class="sd">    ``FieldType.from_column_value`` on the stored column value before returning</span>
<span class="sd">    it the the user.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">translate</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param reader: the underlying ColumnReader object to get values from.</span>
<span class="sd">        :param translate: a function that takes a value from the underlying</span>
<span class="sd">            reader and returns a translated value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reader</span> <span class="o">=</span> <span class="n">reader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_translate</span> <span class="o">=</span> <span class="n">translate</span>

    <span class="k">def</span> <span class="nf">raw_column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the underlying column reader.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reader</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reader</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reader</span><span class="p">[</span><span class="n">docnum</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">sort_key</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">translate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">translate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reader</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">set_reverse</span><span class="p">()</span>


<span class="c1"># Column wrappers</span>


<span class="k">class</span> <span class="nc">WrappedColumn</span><span class="p">(</span><span class="n">Column</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child</span> <span class="o">=</span> <span class="n">child</span>

    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">stores_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">stores_lists</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">WrappedColumnWriter</span><span class="p">(</span><span class="n">ColumnWriter</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child</span> <span class="o">=</span> <span class="n">child</span>

    <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docnum</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">WrappedColumnReader</span><span class="p">(</span><span class="n">ColumnReader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child</span> <span class="o">=</span> <span class="n">child</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">sort_key</span><span class="p">(</span><span class="n">docnum</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">set_reverse</span><span class="p">()</span>


<div class="viewcode-block" id="ClampedNumericColumn"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.ClampedNumericColumn">[docs]</a><span class="k">class</span> <span class="nc">ClampedNumericColumn</span><span class="p">(</span><span class="n">WrappedColumn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An experimental wrapper type for NumericColumn that clamps out-of-range</span>
<span class="sd">    values instead of raising an exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">WrappedColumnWriter</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span> <span class="o">=</span> <span class="n">child</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_min</span> <span class="o">=</span> <span class="n">typecode_min</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">_typecode</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max</span> <span class="o">=</span> <span class="n">typecode_max</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">_typecode</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span></div>


<div class="viewcode-block" id="PickleColumn"><a class="viewcode-back" href="../../api/columns.html#whoosh.columns.PickleColumn">[docs]</a><span class="k">class</span> <span class="nc">PickleColumn</span><span class="p">(</span><span class="n">WrappedColumn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts arbitrary objects to pickled bytestrings and stores them using</span>
<span class="sd">    the wrapped column (usually a :class:`VarBytesColumn` or</span>
<span class="sd">    :class:`CompressedBytesColumn`).</span>

<span class="sd">    If you can express the value you want to store as a number or bytestring,</span>
<span class="sd">    you should use the appropriate column type to avoid the time and size</span>
<span class="sd">    overhead of pickling and unpickling.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">WrappedColumnWriter</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;PickleWriter&gt;&quot;</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">emptybytes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docnum</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">WrappedColumnReader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;PickleReader&gt;&quot;</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">loads</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">loads</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>


<span class="c1"># List columns</span>


<span class="k">class</span> <span class="nc">ListColumn</span><span class="p">(</span><span class="n">WrappedColumn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">stores_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">ListColumnReader</span><span class="p">(</span><span class="n">ColumnReader</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">docnum</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">docnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">VarBytesListColumn</span><span class="p">(</span><span class="n">ListColumn</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child</span> <span class="o">=</span> <span class="n">VarBytesColumn</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">WrappedColumnWriter</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">ls</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">varint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docnum</span><span class="p">,</span> <span class="n">emptybytes</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">ListColumnReader</span><span class="p">,</span> <span class="n">WrappedColumnReader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="n">bio</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">read_varint</span><span class="p">(</span><span class="n">bio</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                <span class="n">vlen</span> <span class="o">=</span> <span class="n">read_varint</span><span class="p">(</span><span class="n">bio</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">bio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">vlen</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>


<span class="k">class</span> <span class="nc">FixedBytesListColumn</span><span class="p">(</span><span class="n">ListColumn</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixedlen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">fixedlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child</span> <span class="o">=</span> <span class="n">VarBytesColumn</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">WrappedColumnWriter</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">fixedlen</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span> <span class="o">=</span> <span class="n">child</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">fixedlen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lengths</span> <span class="o">=</span> <span class="n">GrowableArray</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">,</span> <span class="n">ls</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">emptybytes</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docnum</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="n">ListColumnReader</span><span class="p">,</span> <span class="n">WrappedColumnReader</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">fixedlen</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span> <span class="o">=</span> <span class="n">child</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span> <span class="o">=</span> <span class="n">fixedlen</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnum</span><span class="p">):</span>
            <span class="n">fixedlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixedlen</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="p">[</span><span class="n">docnum</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">fixedlen</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">fixedlen</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">ls</span>


<span class="c1"># class RefListColumn(Column):</span>
<span class="c1">#    def __init__(self, fixedlen=0):</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        :param fixedlen: an optional fixed length for the values. If you</span>
<span class="c1">#            specify a number other than 0, the column will require all values</span>
<span class="c1">#            to be the specified length.</span>
<span class="c1">#        :param default: a default value to use for documents that don&#39;t specify</span>
<span class="c1">#            one. If you don&#39;t specify a default, the column will use an empty</span>
<span class="c1">#            bytestring (``b&#39;&#39;``), or if you specify a fixed length,</span>
<span class="c1">#            ``b&#39;\\x00&#39; * fixedlen``.</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#        self._fixedlen = fixedlen</span>
<span class="c1">#</span>
<span class="c1">#    def stores_lists(self):</span>
<span class="c1">#        return True</span>
<span class="c1">#</span>
<span class="c1">#    def writer(self, dbfile):</span>
<span class="c1">#        return self.Writer(dbfile, self._fixedlen)</span>
<span class="c1">#</span>
<span class="c1">#    def reader(self, dbfile, basepos, length, doccount):</span>
<span class="c1">#        return self.Reader(dbfile, basepos, length, doccount, self._fixedlen)</span>
<span class="c1">#</span>
<span class="c1">#    class Writer(ColumnWriter):</span>
<span class="c1">#        def __init__(self, dbfile, fixedlen):</span>
<span class="c1">#            self._dbfile = dbfile</span>
<span class="c1">#            self._fixedlen = fixedlen</span>
<span class="c1">#</span>
<span class="c1">#            self._refs = GrowableArray(allow_longs=False)</span>
<span class="c1">#            self._lengths = GrowableArray(allow_longs=False)</span>
<span class="c1">#            self._count = 0</span>
<span class="c1">#</span>
<span class="c1">#        def __repr__(self):</span>
<span class="c1">#            return &quot;&lt;RefList.Writer&gt;&quot;</span>
<span class="c1">#</span>
<span class="c1">#        def fill(self, docnum):</span>
<span class="c1">#            if docnum &gt; self._count:</span>
<span class="c1">#                self._lengths.extend(0 for _ in range(docnum - self._count))</span>
<span class="c1">#</span>
<span class="c1">#        def add(self, docnum, ls):</span>
<span class="c1">#            uniques = self._uniques</span>
<span class="c1">#            refs = self._refs</span>
<span class="c1">#</span>
<span class="c1">#            self.fill(docnum)</span>
<span class="c1">#            self._lengths.append(len(ls))</span>
<span class="c1">#            for v in ls:</span>
<span class="c1">#                try:</span>
<span class="c1">#                    i = uniques[v]</span>
<span class="c1">#                except KeyError:</span>
<span class="c1">#                    uniques[v] = i = len(uniques)</span>
<span class="c1">#                refs.append(i)</span>
<span class="c1">#</span>
<span class="c1">#            self._count = docnum + 1</span>
<span class="c1">#</span>
<span class="c1">#        def finish(self, doccount):</span>
<span class="c1">#            dbfile = self._dbfile</span>
<span class="c1">#            refs = self._refs.array</span>
<span class="c1">#            lengths = self._lengths.array</span>
<span class="c1">#</span>
<span class="c1">#            self.fill(doccount)</span>
<span class="c1">#            dbfile.write_byte(ord(lengths.typecode))</span>
<span class="c1">#            dbfile.write_array(lengths)</span>
<span class="c1">#            dbfile.write_byte(ord(refs.typecode))</span>
<span class="c1">#            self._write_uniques(refs.typecode)</span>
<span class="c1">#            dbfile.write_array(refs)</span>
<span class="c1">#</span>
<span class="c1">#    class Reader(ListColumnReader):</span>
<span class="c1">#        def __init__(self, dbfile, basepos, length, doccount, fixedlen):</span>
<span class="c1">#            self._dbfile = dbfile</span>
<span class="c1">#            self._basepos = basepos</span>
<span class="c1">#            self._doccount = doccount</span>
<span class="c1">#            self._fixedlen = fixedlen</span>
<span class="c1">#</span>
<span class="c1">#            dbfile.seek(basepos)</span>
<span class="c1">#            lencode = chr(dbfile.read_byte())</span>
<span class="c1">#            self._lengths = dbfile.read_array(lencode, doccount)</span>
<span class="c1">#</span>
<span class="c1">#            self._typecode = chr(dbfile.read_byte())</span>
<span class="c1">#            refst = struct.Struct(&quot;!&quot; + self._typecode)</span>
<span class="c1">#            self._unpack = refst.unpack</span>
<span class="c1">#            self._itemsize = refst.size</span>
<span class="c1">#</span>
<span class="c1">#            self._read_uniques()</span>
<span class="c1">#            self._refbase = dbfile.tell()</span>
<span class="c1">#</span>
<span class="c1">#            # Create an array of offsets into the references using the lengths</span>
<span class="c1">#            offsets = array(&quot;i&quot;, (0,))</span>
<span class="c1">#            for length in self._lengths:</span>
<span class="c1">#                offsets.append(offsets[-1] + length)</span>
<span class="c1">#            self._offsets = offsets</span>
<span class="c1">#</span>
<span class="c1">#        def __repr__(self):</span>
<span class="c1">#            return &quot;&lt;RefBytes.Reader&gt;&quot;</span>
<span class="c1">#</span>
<span class="c1">#        def _get_ref(self, docnum):</span>
<span class="c1">#            pos = self._basepos + 1 + docnum * self._itemsize</span>
<span class="c1">#            return self._unpack(self._dbfile.get(pos, self._itemsize))[0]</span>
<span class="c1">#</span>
<span class="c1">#        def __getitem__(self, docnum):</span>
<span class="c1">#            offset = self._offsets[docnum]</span>
<span class="c1">#            length = self._lengths[docnum]</span>
<span class="c1">#</span>
<span class="c1">#            pos = self._refbase + offset * self._itemsize</span>
<span class="c1">#            reflist = self._dbfile.get_array(pos, self._typecode, length)</span>
<span class="c1">#            return [self._uniques[ref] for ref in reflist]</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2007-2012 Matt Chaput.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>